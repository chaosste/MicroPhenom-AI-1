name: Deploy to Azure Web App

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build

      - name: Create deploy bundle
        run: |
          rm -rf deploy deploy.zip
          mkdir deploy
          cp -R dist deploy/dist
          cp server.js deploy/server.js
          cp package.json deploy/package.json
          cp package-lock.json deploy/package-lock.json
          cd deploy
          zip -r ../deploy.zip .

      - name: Zip Deploy to Azure
        run: |
          curl --fail-with-body -X POST \
            -u "${{ secrets.AZURE_WEBAPP_DEPLOY_USERNAME }}:${{ secrets.AZURE_WEBAPP_DEPLOY_PASSWORD }}" \
            --data-binary @deploy.zip \
            "https://microphenom.scm.azurewebsites.net/api/zipdeploy"

      - name: Health Check
        run: |
          for i in {1..20}; do
            code=$(curl -s -o /tmp/health.json -w "%{http_code}" https://microphenom.azurewebsites.net/api/health || true)
            if [ "$code" = "200" ]; then
              cat /tmp/health.json
              exit 0
            fi
            sleep 5
          done
          echo "Health check failed"
          exit 1
